<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 카카오 맵 API 스크립트를 포함합니다. -->
    <script type="text/javascript"
        src="http://dapi.kakao.com/v2/maps/sdk.js?appkey=3685359af7ca6763d779579b4174dce7"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- 카카오 맵 API 스크립트를 포함합니다. -->
    <script type="text/javascript"
        src="http://dapi.kakao.com/v2/maps/sdk.js?appkey=3685359af7ca6763d779579b4174dce7"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <title>Document</title>
</head>

<body>


    <!-- Navigation Bar -->
    <nav class="navbar" role="navigation" aria-label="main navigation">
        <!-- Navigation Bar -->
        <nav class="navbar" role="navigation" aria-label="main navigation">
            <div class="navbar-menu">
                <div class="navbar-end">
                    <div class="navbar-item">
                        <div class="buttons">
                            <a class="button is-light" href="/login">로그인</a>
                            <a class="button is-primary" href="/register">회원가입</a>
                            <a class="button is-light" href="/login">로그인</a>
                            <a class="button is-primary" href="/register">회원가입</a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Map Container -->
        <div id="map" style="width: 500px; height: 400px;"></div>


        <script type="text/javascript">
            $(document).ready(function () {
                // 카카오 맵 API 로드가 완료된 후에 initMap 함수 호출
                kakao.maps.load(initMap);
            });

            function initMap() {
                var container = document.getElementById('map');
                var options = {
                    center: new kakao.maps.LatLng(37.297875428836804, 127.03861803212595),
                    level: 3
                };

                var map = new kakao.maps.Map(container, options);

                // createMarker 함수 호출
                createMarker(map);
            }


            function createMarker(map) {
                $.ajax({
                    type: "POST",
                    url: "/api/createMarker",
                    data: {},
                    success: function (response) {
                        let datalist = response['data_list']

                        for (let i = 0; i < datalist.length; i++) {
                            let data = datalist[i]
                            let placename = data['placename']
                            let url = data['place_url']
                            let lat = parseFloat(data['lat']);  // 문자열을 숫자로 변환
                            let lng = parseFloat(data['lng']);  // 문자열을 숫자로 변환

                            // 마커가 표시될 위치입니다 
                            var markerPosition = new kakao.maps.LatLng(lng, lat);

                            // 마커를 생성합니다
                            var marker = new kakao.maps.Marker({
                                position: markerPosition
                            });

                            // 마커가 지도 위에 표시되도록 설정합니다
                            marker.setMap(map);

                        }

                    }
                })
            }
        </script>
        <!-- Map Container -->
        <div id="map" style="width: 500px; height: 400px;"></div>


        <script type="text/javascript">
            $(document).ready(function () {
                // 카카오 맵 API 로드가 완료된 후에 initMap 함수 호출
                kakao.maps.load(initMap);
            });

            var openCustomOverlay = null; // 커스텀 오버레이를 추적하는 변수를 함수 밖에 정의

            function initMap() {
                var container = document.getElementById('map');
                var options = {
                    center: new kakao.maps.LatLng(37.297875428836804, 127.03861803212595),
                    level: 3
                };

                var map = new kakao.maps.Map(container, options);

                // createMarker 함수 호출
                createMarker(map);
            }


            function createMarker(map) {
                $.ajax({
                    type: "POST",
                    url: "/api/createMarker",
                    data: {},
                    success: function (response) {
                        let datalist = response['data_list'];

                        for (let i = 0; i < datalist.length; i++) {
                            let data = datalist[i];
                            let placename = data['placename'];
                            let url = data['place_url'];
                            let lat = parseFloat(data['lat']);
                            let lng = parseFloat(data['lng']);

                            // 마커가 표시될 위치입니다 
                            var markerPosition = new kakao.maps.LatLng(lng, lat);

                            // 마커를 생성합니다
                            var marker = new kakao.maps.Marker({
                                position: markerPosition
                            });

                            // 마커가 지도 위에 표시되도록 설정합니다
                            marker.setMap(map);

                            // 커스텀 오버레이 생성
                            var content = '<div style="padding:5px;font-size:12px;">' + placename + '<br><a href="' + url + '" target="_blank">상세정보 보기</a></div>';
                            var customOverlay = new kakao.maps.CustomOverlay({
                                position: markerPosition,
                                content: content,
                                xAnchor: 0.5,
                                yAnchor: 1.5,
                            });

                            // 마커 클릭 이벤트 등록
                            kakao.maps.event.addListener(marker, 'click', makeClickListener(map, marker, customOverlay));
                        }
                    }
                });
            }

            // 클릭 이벤트 생성 함수
            function makeClickListener(map, marker, customOverlay) {
                return function () {
                    // 클릭한 마커에 연결된 커스텀 오버레이를 지도 위에 표시합니다
                    if (openCustomOverlay) {
                        openCustomOverlay.setMap(null);
                    }
                    customOverlay.setMap(map);
                    openCustomOverlay = customOverlay;
                };
            }
        </script>
</body>

</html>